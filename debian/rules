#!/usr/bin/make -f

include /usr/share/dpatch/dpatch.make

build: build-stamp
build-stamp: patch-stamp
# One of
	dh_testdir
	./mkrelease.sh && xmkmf
	cd doc/man/guide/tex && xmkmf
	$(MAKE) canna
	$(MAKE) -C doc/man/guide/tex
	touch build-stamp

clean: unpatch
# No need to run clean
	dh_testdir
	dh_testroot
	-$(MAKE) clean
	-$(MAKE) distclean
	-$(MAKE) -C doc/man/guide/tex clean
	-$(MAKE) -C doc/man/guide/tex distclean

	# remove created symlinks
	rm -f doc/intern/canna.sty doc/lisp/canna.sty doc/man/guide/tex/canna.sty doc/misc/canna.sty 

	# remove generated files 
	rm -f configure canuum/configure canuum/config.h.in Canna.conf accanna.h.in
	rm -f build-stamp 

	dh_clean

binary-indep: build

binary-arch: build
	dh_testdir -a
	dh_testroot -a
	dh_clean -a -k
	dh_installdirs -a

	make install \
		cannaBinDir=`pwd`/debian/canna/usr/bin \
		cannaSrvDir=`pwd`/debian/canna/usr/sbin \
		cannaLibDir=`pwd`/debian/canna/var/lib/canna \
		cannaEtcDir=`pwd`/debian/canna/etc/canna \
		cannaShareDir=`pwd`/debian/canna/usr/share/canna \
		cannaManDir=`pwd`/debian/canna/usr/share/man \
		cannaIncDir=`pwd`/debian/canna/usr/include/canna \
		libCannaDir=`pwd`/debian/canna/usr/lib \
		cannaDocDir=`pwd`/debian/canna/usr/share/doc/libcanna1g \
		DicDir=`pwd`/debian/canna/var/lib/canna/dic \
		ErrDir=`pwd`/debian/canna/var/log/canna
	make install.man \
		cannaManDir=`pwd`/debian/canna/usr/share/man \
		MANSUFFIX=1 LIBMANSUFFIX=3

	# debug
	find debian/canna/

	(cd debian/canna/usr/bin/ && rm -f cpdic lsdic mkdic mvdic rmdic syncdic addwords delwords cannakill)
	cp debian/canna/usr/bin/catdic debian/canna/usr/bin/cannakill
	install -d -m 755 debian/canna/etc/canna/dics.dir.d
	install -m 644 debian/canna/var/lib/canna/dic/canna/dics.dir debian/canna/etc/canna/dics.dir.d/00canna.dics.dir
	rm -f debian/canna/var/lib/canna/dic/canna/dics.dir
	# 3.7 tries to install symlink to cannakill here, ignore it.
	rm -f debian/canna/usr/sbin/cannakill

	install -m 755 debian/update-canna-dics_dir debian/canna/usr/sbin

	# move /var/lib/canna/dic/*.cld and related file to template dir
	install -d -m 755 debian/canna/usr/lib/canna/debian-template/
	mv debian/canna/var/lib/canna/dic/canna/*.cld debian/canna/var/lib/canna/dic/canna/iroha.cbd debian/canna/var/lib/canna/dic/canna/fuzokugo.cbd debian/canna/usr/lib/canna/debian-template/
	chown -R root:root debian/canna/usr/lib/canna/debian-template/

	dh_installdebconf
	dh_installexamples
	dh_installmenu
	dh_movefiles --sourcedir=debian/canna
	-rmdir -p debian/canna/usr/share/doc/libcanna1g/sample/src
	-rmdir -p debian/canna/usr/include/canna debian/canna/usr/lib
	dh_installdocs
	dh_installexamples
	#dh_undocumented crfreq.1 crxdic.1 crxgram.1 dpxdic.1\
	#forcpp.1 forsort.1 kpdic.1 mergeword.1 syncdic.1
	dh_installinit
	dh_installman -pcanna ./cmd/catdic/chmoddic.man  \
		debian/update-canna-dics_dir.8 \
		debian/canlisp.1 \
		debian/forsort.1 \
		debian/mergeword.1
	dh_installman -pcanna-utils ./debian/chkconc.1 
	dh_installchangelogs ChangeLog
	dh_strip
	dh_link
	dh_compress
	dh_fixperms
	dh_makeshlibs -V 
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb


binary: binary-indep binary-arch
